// Выделяем инпут при загрузке страницы
$(document).ready(function(){
   $("section.firstscreen input").focus();
});



//  Добавляем/убираем значок "больше" при длинном value в input
$("input[name='seller']").on("keyup change", function(){
    if ($(this).val().length >= 60) {
        $(this).parents("form").addClass("filled");
    } else {$(this).parents("form").removeClass("filled");}
});



$("#rating1, #rating2, #rating3").change(function(){
   if ( $("#rating1").prop("checked") === true ) {
       $(".reviews .ratinglist .ratingselect .icon.plus").show();
   } else {$(".reviews .ratinglist .ratingselect .icon.plus").hide();}

   if ( $("#rating2").prop("checked") === true ) {
       $(".reviews .ratinglist .ratingselect .icon.neutral").show();
   } else {$(".reviews .ratinglist .ratingselect .icon.neutral").hide();}

   if ( $("#rating3").prop("checked") === true ) {
       $(".reviews .ratinglist .ratingselect .icon.minus").show();
   } else {$(".reviews .ratinglist .ratingselect .icon.minus").hide();}

   if ( ($("#rating1").prop("checked") === false) && ($("#rating2").prop("checked") === false) && ($("#rating3").prop("checked") === false) ) {
       $(".reviews .ratinglist .ratingselect .icon").show();
   }
});



$("html").click(function(){
    $("#openrating").prop("checked", false);
});

$(".ratinglist").click(function(event){
    event.stopPropagation();
});



// Параллакс бекграунда во втором блоке
function scrollsecond() {
    var el = $("section.second");
    var h1 = el.offset().top;
    var sectionheight = el.height();
    var scroll = $(window).scrollTop();
    var percents = scroll/sectionheight;
    $("section.second ").css("top", (percents*300)+"px").css("opacity", 1-percents);
}



// Ссылки навигации по странице (добавить класс nav к ссылке с #)
$("a.nav").click(function(event){
    event.preventDefault();
    $('html,body').animate({scrollTop:$(this.hash).offset().top}, 1200);
});

$("a.mainnav").click(function(event){
    event.preventDefault();
    $('html,body').animate({scrollTop:$(this.hash).offset().top-90}, 700);
});



// Показать, если хороший
function showgood() {
    $("section.second").addClass("good").removeClass("bad");
    $("#yesorno").text("Да, можно покупать");
    var rating = "85";
    $("#ratingnumber").text(rating);
    var textrating = "очень хороший";
    $("#textrating").text(textrating);
}

// Показать плохой
function showbad() {
    $("section.second").removeClass("good").addClass("bad");
    $("#yesorno").text("Не нужно покупать");
    var rating = "35";
    $("#ratingnumber").text(rating);
    var textrating = "плохой";
    $("#textrating").text(textrating);
}



// AJAX форма
$(document).ready(function() {
    $('.firstscreen form').ajaxForm(function() {
        // Успешная отправка формы
        $(".actionblock__sellerlink").text($("section.firstscreen input[name='seller']").val());

        if ($("section.firstscreen input[name='seller']").val() === "bad") {
            showbad();
        }

        if ($("section.firstscreen input[name='seller']").val() === "good") {
            showgood();
        }

        var height = $("section.firstscreen").css("height");
        $("section.firstscreen").css("height", height);
        $("body").addClass("active");

		$('.siteloader').addClass('active');
		sitepreloader();

        setTimeout(function(){
            $("div.content").css("margin-top", "-"+height);
//            $(".topblock").addClass("visible");

        }, 10000);

        setTimeout(function(){
//            $(".topblock").addClass("visible");
        }, 10200);



		//Показать еще комментарии
		var comments = $("#comments ul li").length;
		$("#comments .buttons").hide();
		if (comments > 5) {

			var commHeight = 0;
			var allcommHeight = 0;

			for (var i=0; i<5; i++) {
				commHeight += $("#comments ul li").eq(i).outerHeight(true);
			};

			for (var i=0; i<comments; i++) {
				allcommHeight += $("#comments ul li").eq(i).outerHeight(true);
			};

			$("#comments ul").height(commHeight);
			$("#comments .buttons").show();
		}

		$("[href='#morecomments']").click(function(event){
			event.preventDefault();
			$("#comments ul").height(allcommHeight);
			$(this).parent().addClass("active");
			setTimeout(function(){
            	$("#comments ul").css("height", "auto");
        	}, 1000);
		});


        // Кастомный скроллбар
$("#seller").selectmenu();
$("#rating").selectmenu();
$("#range").selectmenu();

        setTimeout(function(){
            /*$(".scrollable").customScrollbar({
                skin: "default-skin",
                hScroll: false,
                updateOnWindowResize: true
            });*/

			$(document).ready(function(){
				$('.scrollbar-inner').scrollbar();
			});

            /*
            if ( $(window).width() < 1350 ) {
                window.bh = $("body").height();
                $("body").height(bh*zoomlevel);
                $(".ui-selectmenu-button").click(function(){
                    setTimeout(function(){
                   $(".ui-selectmenu-menu").css("transform", "transform:scale("+zoomlevel+") !important").css("transform-origin", "left top !important");
                        }, 200);
                });
            }      */

        }, 1000);

        $(window).scroll(function(){
            scrollsecond();
        });
	});

	$('.topblock form').ajaxForm(function() {
        // Успешная отправка формы
        if ($(".topblock .inputblock input").val() != "") {
            $(".topblock").removeClass("active");

            if ($(".topblock .inputblock input").val() === "bad") {
                showbad();
            }

            if ($(".topblock .inputblock input").val() === "good") {
                showgood();
            }

            $(".actionblock__sellerlink").text($(".topblock input").val());

            $(".topblock .inputblock input").val("");
			$('.topblock .button').removeClass('active');
        } else {
            showerror("emptyerror");
        }
	});
});





// Зум сайта
function zoom() {
    if ( $(window).width() < 1350 ) {
        window.wwidth = $(window).width();
        window.zoomlevel = wwidth/1380;
        $(".bigwrapper").attr("style", "transform:scale("+zoomlevel+"); transform-origin: left top;");
        window.bh = $("body").height();
        $("body").height(bh*zoomlevel);
    }
}




// Окошко ошибки
function showerror(errorid) {
    window.activeerror = $(".errorblock#"+errorid);
    activeerror.addClass("active");
    setTimeout(function(){
        hideerror();
    }, 10000);
}

function hideerror() {
    activeerror.removeClass("active");
}

$('.errorblock [href="#close"]').click(function(){
   hideerror();
});





// Проверка на заполненность
$('.firstscreen form button, .topblock form button').click(function(event){
    event.preventDefault();
    if ( $(this).parents("form").find("input").val() === "" ) {
        showerror("emptyerror");
    } else { $(this).parents("form").submit(); }
});








// Добавить в избранное
function addtobookmarks() {
    var url = $("#tofavourites").prev().text();

    if (window.sidebar && window.sidebar.addPanel) { // Mozilla Firefox Bookmark
      window.sidebar.addPanel(document.title, url, '');
    } else if (window.external && ('AddFavorite' in window.external)) { // IE Favorite
      window.external.AddFavorite(url, document.title);
    } else if (window.opera && window.print) { // Opera Hotlist
      this.title = document.title;
      return true;
    } else { // webkit - safari/chrome
      alert('Нажмите ' + (navigator.userAgent.toLowerCase().indexOf('mac') != -1 ? 'Command/Cmd' : 'CTRL') + ' + D, чтобы добавить страницу в закладки.');
    }

//    showerror("bookmarkinfo");
}

$('#tofavourites').click(function() {
    addtobookmarks();
});








// Прилипающая плашка сверху контент
/*
$(window).scroll(function(){
    var scroll = $(this).scrollTop();
	var height = $("section.content").offset().top;
    if ( scroll > height ) {
        $(".topblock").addClass("fixed");
    } else { $(".topblock").removeClass("fixed"); }
});*/

// Смена блоков в плашке
$("a[href='#change']").click(function(event){
	event.preventDefault();
	$(".topblock").addClass("active");
});

$(".topblock a[href='#cancel']").click(function(event){
	event.preventDefault();
	$(".topblock").removeClass("active");
});


// Маска для поля ввода телефона
$(document).ready(function(){
   $("input[name='tel']").inputmask("+7 (999) 999-99-99");
});





// Кросс-браузерный Placeholder
function supports_input_placeholder() {var i = document.createElement('input'); return 'placeholder' in i;}

if (!supports_input_placeholder()) {
  var fields = document.getElementsByTagName('INPUT');
  for(var i=0; i < fields.length; i++) {
    if(fields[i].hasAttribute('placeholder')) {
      fields[i].defaultValue = fields[i].getAttribute('placeholder');
      fields[i].onfocus = function() { if(this.value == this.defaultValue) this.value = ''; }
      fields[i].onblur = function() { if(this.value == '') this.value = this.defaultValue; }
    }
  }
}


//Preloader
$(document).ready(function(){

});

function sitepreloader() {
	$('.siteloader__circles, .siteloader__progress').addClass('visible');
	setTimeout(function(){
		window.activeCircleIndex = 1;
		circlefunc();
		progressbar();
		percentcount();
		changetext();
	}, 500);

}

function circlefunc() {
	var activeCircle = $(".siteloader__icon:nth-of-type("+activeCircleIndex+")");

	if (activeCircleIndex == 5) {
		setTimeout(function(){
			activeCircle.addClass("siteloader__icon_pink");
		}, 2000);
		setTimeout(function(){
			$('.siteloader__circles, .siteloader__progress').removeClass('visible');
			$('.siteloader').removeClass('active');
		}, 3000);

   	} else {


     	setTimeout(function(){
			activeCircle.addClass("siteloader__icon_white siteloader__icon_right-dark")
		}, 0);

		setTimeout(function(){
			activeCircle.addClass(" siteloader__icon_right-pink");
			activeCircle.next().addClass("siteloader__icon_left-dark");
		}, 1000);

     	setTimeout(function(){
			activeCircle.addClass("siteloader__icon_pink");
			activeCircle.next().addClass("siteloader__icon_white siteloader__icon_left-pink");

       		activeCircleIndex += 1;
       		circlefunc();
     	}, 2000);
	}
}

function progressbar() {
	$('.siteloader__progress_bar_progressive').addClass('active');
	$('.siteloader__progress_texts').addClass('active');
}

function percentcount() {
	var counter = 100;
	$({countNum: 0}).animate({countNum: counter}, {
    	duration: 10000,
        easing:'linear',
        step: function() {
        	$('.siteloader__progress_texts_percent span').text(Math.floor(this.countNum));
        },
        complete: function() {
            $('.siteloader__progress_texts_percent span').text(this.countNum);
        }
	});
}

function changetext() {
	setTimeout(function(){
		$('.siteloader__progress_texts_text').text('Отправляю запрос');
    }, 2000);
	setTimeout(function(){
		$('.siteloader__progress_texts_text').text('Жду ответ');
    }, 4000);
	setTimeout(function(){
		$('.siteloader__progress_texts_text').text('Получаю данные');
    }, 6000);
	setTimeout(function(){
		$('.siteloader__progress_texts_text').text('Анализирую продавца');
    }, 8000);
}



// Расширенный header
$('.actionblock__icon_burger').click(function(e){
	e.preventDefault();
	$(this).toggleClass('active');
	var actions = $(this).parents('.actions');
	var header = $(this).parents('.actions').siblings('.header');
	header.addClass('invisible');
	$('.searchblock__categories').removeClass('active');
	$('.searchblock__menu_categories').removeClass('active');
	setTimeout(function(){
		header.toggleClass('active');
		actions.toggleClass('fullheader');
	}, 250)
	setTimeout(function(){
		header.removeClass('invisible');
	}, 500)
});

// Появление кнопки проверки в форме на первом экране
$('form input').keyup(function(){
	if ( $(this).val() ) {
		$(this).parent().siblings().find('button').addClass('active');
	} else {
		$(this).parent().siblings().find('button').removeClass('active');
	}
});

// Текст ссылки при клике на значок more
$('.inputblock .more').click(function(e){
	e.stopPropagation();
	var inputVal;
	if ( $(this).next('input').length ) {
		inputVal = $(this).next().val();
	} else {
		inputVal = $(this).next().text();
	}
	$(this).siblings('.inputlink').text(inputVal);
	$(this).siblings('.inputlink').toggleClass('active');
});
$('.inputlink').click(function(e){
	e.stopPropagation();
});
$('html').click(function(){
	$('.inputlink').removeClass('active');
});



// Навигация карточек
$(document).ready(function(){
	$('.cardnav').each(function(){
		var navcards = $(this).siblings('.js-navcards');
		var containerWidth = navcards.width();
		var cardsWidth = 0;
		navcards.children().each(function(){
			cardsWidth = cardsWidth + $(this).outerWidth(true);
		});
		if ( cardsWidth > containerWidth ) {
			$(this).addClass('right-arrow');
		}
	});
});

$('.cardnav__arrow').click(function(e){
	e.preventDefault();
	var navcards = $(this).parent().siblings('.js-navcards');
	var containerWidth = navcards.width();
	var cardsWidth = 0;
	navcards.children().each(function(){
		cardsWidth = cardsWidth + $(this).outerWidth(true);
	});
	var containerTranslation = parseInt(navcards.css('transform').split(',')[4]);
	containerTranslation = Math.abs(containerTranslation);
	var diffWidth = cardsWidth - containerWidth - containerTranslation;
	if ( $(this).hasClass('next') ) {
		if ( diffWidth < 0 ) {
			return false;
		} else if ( diffWidth >= 0 && diffWidth <= containerWidth ) {
			navcards.css('transform', 'translate3d(-'+(diffWidth+containerTranslation)+'px,0,0)');
			$(this).parent().removeClass('right-arrow');
			$(this).parent().addClass('left-arrow');
		} else {
			navcards.css('transform', 'translate3d(-'+(containerWidth+containerTranslation)+'px,0,0)');
			$(this).parent().addClass('left-arrow');
		}
	} else {
		if ( containerTranslation == 0 ) {
			return false;
		} else if ( containerTranslation > 0 && containerTranslation <= containerWidth ) {
			navcards.css('transform', 'translate3d(0,0,0)');
			$(this).parent().removeClass('left-arrow');
			$(this).parent().addClass('right-arrow');
		} else {
			navcards.css('transform', 'translate3d(-'+(containerTranslation-containerWidth)+'px,0,0)');
			$(this).parent().addClass('right-arrow');
		}
	}
});